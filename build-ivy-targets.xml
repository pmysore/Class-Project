<project basedir="." default="resolve" xmlns:ivy="antlib:org.apache.ivy.ant">
	<import file="build-ant-contrib-targets.xml" />
	<import file="build-basic-targets.xml" />

	<property file="placeholder.build.properties" />
	<property name="ivy.settings.dir" value="${shared.xml}/ant/ivy" />
	<property file="${ivy.settings.dir}/ivysettings.properties" />

	<path id="ivy.lib.path">
		<fileset dir="${shared.lib}">
			<include name="ant-extensions/ivy-*.jar" />
		</fileset>
	</path>

	<path id="lib.jars">
		<fileset id="lib.jars.fileset" dir="lib" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
	</path>

	<target name="load-ivy">
		<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path" />
		<ivy:settings file="${ivy.settings.dir}/ivysettings.xml" />
	</target>

	<target name="ivy-new-version" depends="load-ivy" unless="ivy.new.revision">
		<ivy:info />
		<ivy:buildnumber organisation="${ivy.organisation}" module="${ivy.module}" defaultBuildNumber=".1" revSep="" revision="${archive.version}" />
	</target>

	<target name="ivy-local-version">
		<tstamp>
			<format property="now" pattern="yyyyMMddHHmmss" />
		</tstamp>

		<propertyfile file="${build.dir}/version.properties">
			<entry key="version" type="int" operation="+" default="0" />
		</propertyfile>
		<property file="${build.dir}/version.properties" />
		<property name="revision" value="${archive.version}.${now}" />
	</target>

	<target name="ivy-version">
		<tstamp>
			<format property="now" pattern="yyyyMMddHHmmss" />
		</tstamp>
		<property name="revision" value="${archive.version}.${now}" />

		<!-- create version file in classpath for later inclusion in jar -->
		<echo message="version=${revision}" file="${build.dir}/version.properties" append="false" />
	</target>
	<target name="resolve" depends="clean-lib, load-ivy" description="--> resolve and retrieve dependencies with ivy">
		<echo message="Storing dependencies in lib dir: ${lib.dir}" />
		<mkdir dir="lib"/>
		<ivy:retrieve />

		<ivy:deliver deliverpattern="ivy_delivered.xml" />
	</target>

	<target name="resolve-all" depends="resolve">
		<copy todir="lib" flatten="true">
			<path refid="project.classpath"/>
		</copy>
	</target>

	<target name="resolve_delivered" depends="clean-lib, load-ivy" description="--> resolve and retrieve dependencies with ivy">
		<echo message="Storing dependencies in lib dir: ${lib.dir}" />
		<ivy:resolve file="ivy_delivered.xml" />
		<ivy:retrieve />
	</target>

	<target name="publish" depends="resolve,dist,publish-nodeps" description="--> publish this project in the ivy repository" />

	<target name="publish-nodeps" depends="ivy-version">
		<ivy:info />
		<tstamp>
			<format property="now" pattern="yyyyMMddHHmmss" />
		</tstamp>
		<echo message="project ${ant.project.name} being released with version ${revision}" />
		<ivy:publish artifactspattern="dist/[artifact].[ext]" resolver="publish" pubrevision="${revision}" pubdate="${now}" status="release" />
		<echo message="project ${ant.project.name} released with version ${revision}" />
	</target>

	<target name="publish-local" depends="resolve,dist,publish-local-nodeps" description="--> publish this project in the ivy repository" />

	<target name="publish-local-nodeps" depends="ivy-version">
		<ivy:info />
		<tstamp>
			<format property="now" pattern="yyyyMMddHHmmss" />
		</tstamp>
		<echo message="project ${ant.project.name} being released with version ${revision}" />
		<ivy:publish artifactspattern="dist/[artifact].[ext]" resolver="local" pubrevision="${revision}" pubdate="${now}" status="integration" forcedeliver="true" />
		<echo message="project ${ant.project.name} released with version ${revision}" />
	</target>

	<target name="clean-local" depends="load-ivy" description="--> cleans the local repository for the current module">
		<ivy:info />
		<delete dir="${ivy.local.default.root}/${ivy.organisation}/${ivy.module}" />
	</target>

	<target name="clean-all-local" depends="load-ivy" description="--> cleans the local repository for the current module">
		<ivy:info />
		<delete dir="${ivy.local.default.root}" />
	</target>

	<target name="clean-lib" description="--> clean the project libraries directory (dependencies)">
		<delete includeemptydirs="true" dir="${lib.dir}" />
	</target>

	<target name="clean-cache" depends="load-ivy" description="--> clean the cache">
		<ivy:cleancache />
	</target>

	<target name="report" depends="load-ivy, resolve" description="--> generate report">
		<ivy:report />
	</target>

	<target name="post-resolve-echo">
		<echo> 
		        organisation=${dep.organisation} 
		        module=${dep.module} 
		        revision=${dep.revision}
		        artifact=${dep.artifact}
		        type=${dep.type}
		        ext=${dep.ext}
		        origin=${dep.origin}
		        local=${dep.local}
		        size=${dep.size}
		        file=${dep.file}
				status=${dep.status}
				resolver=${dep.resolver}
				pubdate=${dep.pubdate}
				conf=${dep.conf}
		</echo>
	</target>

	<target name="build-dep" depends="publish">
	</target>

	<target name="pom">
		<ivy:makepom pomfile="module.pom">
			<ivy:mapping conf="default" scope="compile"/>
			<ivy:mapping conf="runtime" scope="runtime"/>
		</ivy:makepom>
	</target>
</project>
